<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bias Scanner</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(135deg, #cae14c 0%, #39ecec 100%);
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 20px;
}

.main {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.sidebar {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-height: 800px;
    overflow-y: auto;
}

h1 {
    color: #333;
    margin-bottom: 10px;
    font-size: 28px;
}

.subtitle {
    color: #666;
    margin-bottom: 25px;
    font-size: 14px;
}

.input-group {
    margin-bottom: 20px;
}

label {
    display: block;
    color: #555;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 13px;
}

input[type="file"], textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-family: inherit;
    font-size: 14px;
    transition: border-color 0.3s;
}

input[type="file"]:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
}

textarea {
    height: 300px;
    resize: vertical;
    font-family: 'Monaco', 'Courier New', monospace;
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

button {
    flex: 1;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

#scanBtn {
    background: linear-gradient(135deg, #24d76f 0%, #1e4dce 100%);
    color: white;
}

#scanBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}

#scanBtn:active {
    transform: translateY(0);
}

#clearBtn {
    background: #f5f5f5;
    color: #333;
}

#clearBtn:hover {
    background: #eeeeee;
}

#output {
    margin-top: 30px;
    padding: 20px;
    background: #fafafa;
    border-radius: 8px;
    line-height: 1.8;
    min-height: 200px;
    color: #333;
}

.highlight {
    padding: 2px 6px;
    border-radius: 4px;
    cursor: help;
    position: relative;
    font-weight: 500;
    transition: opacity 0.2s;
}

.highlight:hover {
    opacity: 0.8;
}

.yellow { background-color: #ffeb3b; color: #000; }
.orange { background-color: #ff9800; color: #fff; }
.red { background-color: #f44336; color: #fff; }

.tooltip {
    position: relative;
}

.tooltip:hover::after {
    content: attr(data-tip);
    position: absolute;
    bottom: 125%;
    left: 50%;
    transform: translateX(-50%);
    background: #222;
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    white-space: nowrap;
    z-index: 100;
    pointer-events: none;
}

.tooltip:hover::before {
    content: '';
    position: absolute;
    bottom: 115%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #222;
    z-index: 100;
}

.results-header {
    color: #667eea;
    font-weight: 700;
    margin-bottom: 15px;
    font-size: 15px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.result-item {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 10px;
    border-left: 4px solid #667eea;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.result-item:hover {
    background: #f0f0f0;
    transform: translateX(4px);
}

.result-type {
    display: inline-block;
    background: #667eea;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 4px;
}

.result-reason {
    color: #666;
    margin-top: 4px;
    font-size: 12px;
}

.result-severity {
    display: inline-block;
    margin-top: 4px;
    font-size: 11px;
    color: #999;
}

.loading {
    text-align: center;
    color: #999;
    padding: 20px;
    font-size: 13px;
}

.empty-state {
    text-align: center;
    color: #999;
    padding: 30px 20px;
    font-size: 13px;
}

@media (max-width: 1024px) {
    .container {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        max-height: none;
    }
}
</style>
</head>

<body>

<div class="container">
    <div class="main">
        <h1>Bias Scanner</h1>
        <p class="subtitle">Using this tool, you can find out if any of your text contains any bias, be that political, emotional, or otherwise, and it will highlight and explain each portion containing the bias</p>

        <div class="input-group">
            <label for="fileInput">Load File</label>
            <input type="file" id="fileInput" accept=".txt">
        </div>

        <div class="input-group">
            <label for="text">Text to Analyze</label>
            <textarea id="text" placeholder="Paste your text here..."></textarea>
        </div>

        <div class="button-group">
            <button id="scanBtn" onclick="scan()">Scan for Bias</button>
            <button id="clearBtn" onclick="clearAll()">Clear</button>
        </div>

        <div id="output" class="empty-state">Results will appear here...</div>
    </div>

    <div class="sidebar">
        <div class="results-header">Findings</div>
        <div id="results-list" class="empty-state">No results yet</div>
    </div>
</div>

<script>
let currentResults = [];

document.getElementById("fileInput").addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        document.getElementById("text").value = e.target.result;
    };
    reader.readAsText(file);
});

async function scan() {
    const text = document.getElementById("text").value;
    if (!text.trim()) {
        alert("Please enter some text to scan");
        return;
    }

    document.getElementById("scanBtn").disabled = true;
    document.getElementById("scanBtn").textContent = "Scanning...";

    try {
        const res = await fetch("/scan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
        });

        const data = await res.json();
        currentResults = data.results || [];
        render(text, currentResults);
        updateResultsList(currentResults);
    } finally {
        document.getElementById("scanBtn").disabled = false;
        document.getElementById("scanBtn").textContent = "Scan for Bias";
    }
}

function clearAll() {
    document.getElementById("text").value = "";
    document.getElementById("output").innerHTML = '<div class="empty-state">Results will appear here...</div>';
    document.getElementById("results-list").innerHTML = '<div class="empty-state">No results yet</div>';
    currentResults = [];
}

function severityColor(sev) {
    if (sev < 0.5) return "blue";
    if (sev > 0.5 && sev < 0.75) return "yellow";
    if (sev > 0.75 && sev < 1.0) return "orange";
    return "red";
}

function updateResultsList(results) {
    const list = document.getElementById("results-list");
    if (results.length === 0) {
        list.innerHTML = '<div class="empty-state">No bias detected ✓</div>';
        return;
    }

    list.innerHTML = results.map((r, i) => `
        <div class="result-item">
            <div class="result-type">${r.type}</div>
            <div class="result-reason">${escapeHTML(r.reason)}</div>
            <div class="result-severity">Severity: ${(r.severity * 100).toFixed(0)}%</div>
        </div>
    `).join("");
}

function render(text, results) {
    if (results.length === 0) {
        document.getElementById("output").innerHTML = '<div class="empty-state">No bias detected in this text ✓</div>';
        return;
    }

    let html = escapeHTML(text);

    // Sort results by the position they appear in the text (to avoid conflicts when replacing)
    results.sort((a, b) => {
        const posA = text.indexOf(a.text);
        const posB = text.indexOf(b.text);
        return posA - posB;
    });

    // Replace each problematic text with highlighted version
    for (const r of results) {
        const escapedText = escapeHTML(r.text);
        const highlighted = `<span class="highlight ${severityColor(r.severity)} tooltip" data-tip="Suggestion: ${escapeHTML(r.suggestion)}">${escapedText}</span>`;
        // Use global replace to handle multiple occurrences
        const regex = new RegExp(escapedText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        html = html.replace(regex, highlighted);
    }

    document.getElementById("output").innerHTML = html;
}

function escapeHTML(s) {
    return s.replace(/[&<>"']/g, c => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#39;"
    })[c]);
}
</script>

</body>
</html>
